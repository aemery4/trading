<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Screener & Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f7fafc;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .screener-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .screener-table thead { background: #667eea; color: white; }
        .screener-table th, .screener-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        .screener-table tbody tr:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        .screener-table tbody tr.selected {
            background: #bee3f8;
        }
        .positive { color: #48bb78; font-weight: 600; }
        .negative { color: #f56565; font-weight: 600; }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            display: none;
        }
        .results.show { display: block; }
        .result-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            margin-top: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .result-header:first-child { margin-top: 0; }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-label { font-weight: 600; color: #555; }
        .result-value { font-weight: 600; }
        .avg-return {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .avg-return-label { font-size: 14px; color: #666; margin-bottom: 5px; }
        .avg-return-value { font-size: 32px; font-weight: 700; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .data-table thead tr { background: #e2e8f0; }
        .data-table th { padding: 10px; text-align: left; border: 1px solid #cbd5e0; font-weight: 600; }
        .data-table td { padding: 8px; border: 1px solid #cbd5e0; }
        .data-table td.right { text-align: right; }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .status.show { display: block; }
        .status.loading { background: #bee3f8; color: #2c5282; }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.error { background: #fed7d7; color: #742a2a; }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Ticker Screener & Analysis</h1>
        <p class="subtitle">Upload screener results and analyze qualifying tickers</p>
        
        <div class="upload-section">
            <h3 style="margin-bottom: 15px;">Upload Screener CSV</h3>
            <div class="file-input-wrapper">
                <button class="btn btn-primary">Choose File</button>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <p id="fileName" style="margin-top: 10px; color: #666;"></p>
        </div>

        <div id="screenerSection" style="display: none;">
            <h2 style="margin-bottom: 15px;">Qualifying Tickers</h2>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Screened</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Qualified</div>
                    <div class="stat-value" id="qualifiedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg 5-Day Gain</div>
                    <div class="stat-value" id="avgGain">0%</div>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="screener-table" id="screenerTable">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Description</th>
                            <th>Tech Rating</th>
                            <th>MA Rating</th>
                            <th>Avg 5-Day Gain</th>
                            <th>Last 3 Days Min</th>
                        </tr>
                    </thead>
                    <tbody id="screenerBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <label>Cutoff Date for Analysis:</label>
                <input type="date" id="cutoffDate" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; margin: 10px 0;">
            </div>
        </div>

        <div id="status" class="status"></div>

        <div class="results" id="results">
            <div class="result-header">Daily Analysis</div>
            <div class="result-item">
                <span class="result-label">Symbol:</span>
                <span class="result-value" id="symbolDisplay"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Cutoff Date:</span>
                <span class="result-value" id="dateDisplay"></span>
            </div>
            <div class="avg-return">
                <div class="avg-return-label">Average 5-Day Return</div>
                <div class="avg-return-value" id="avgReturn"></div>
            </div>
            <div class="result-header">Last 5 Trading Days</div>
            <div id="dailyReturns"></div>
            <div class="result-header">Raw Data (Last 10 Days)</div>
            <div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Close Price</th>
                            <th>Daily Return</th>
                        </tr>
                    </thead>
                    <tbody id="rawDataBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" id="exportBtn">Export CSV</button>
            </div>
        </div>
    </div>

    <script>
        var screenerData = [];
        var qualifiedTickers = [];
        var analysisData = null;
        var selectedTicker = null;
        
        document.getElementById('cutoffDate').valueAsDate = new Date();
        
        document.getElementById('csvFile').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = 'Loading: ' + file.name;
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsed:', results.data.length, 'rows');
                    screenerData = results.data;
                    processScreenerData();
                    document.getElementById('fileName').textContent = 'Loaded: ' + file.name;
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        });
        
        function processScreenerData() {
            console.log('Processing screener data...');
            qualifiedTickers = [];
            
            for (var i = 0; i < screenerData.length; i++) {
                var row = screenerData[i];
                
                var techRating = row['Technical Rating 1 day'];
                var maRating = row['Moving Averages Rating 1 day'];
                var weekChange = row['Price Change % 1 week'];
                
                if (!techRating || !maRating) continue;
                
                var isStrongBuy = techRating === 'Strong Buy' && maRating === 'Strong Buy';
                
                if (isStrongBuy && weekChange != null) {
                    var avg5Day = weekChange;
                    var last3Min = weekChange * 0.6;
                    
                    if (last3Min >= 5 && avg5Day >= 8) {
                        qualifiedTickers.push({
                            symbol: row['Symbol'],
                            description: row['Description'],
                            techRating: techRating,
                            maRating: maRating,
                            avg5Day: avg5Day,
                            last3Min: last3Min
                        });
                    }
                }
            }
            
            console.log('Qualified tickers:', qualifiedTickers.length);
            displayQualifiedTickers();
        }
        
        function displayQualifiedTickers() {
            document.getElementById('screenerSection').style.display = 'block';
            
            document.getElementById('totalCount').textContent = screenerData.length;
            document.getElementById('qualifiedCount').textContent = qualifiedTickers.length;
            
            if (qualifiedTickers.length > 0) {
                var totalGain = 0;
                for (var i = 0; i < qualifiedTickers.length; i++) {
                    totalGain += qualifiedTickers[i].avg5Day;
                }
                var avgGain = totalGain / qualifiedTickers.length;
                document.getElementById('avgGain').textContent = avgGain.toFixed(2) + '%';
            }
            
            var tbody = document.getElementById('screenerBody');
            tbody.innerHTML = '';
            
            for (var i = 0; i < qualifiedTickers.length; i++) {
                var ticker = qualifiedTickers[i];
                var row = document.createElement('tr');
                row.setAttribute('data-symbol', ticker.symbol);
                row.onclick = function() {
                    var symbol = this.getAttribute('data-symbol');
                    selectTicker(symbol);
                };
                
                row.innerHTML = '<td><strong>' + ticker.symbol + '</strong></td>' +
                    '<td>' + (ticker.description || '') + '</td>' +
                    '<td>' + ticker.techRating + '</td>' +
                    '<td>' + ticker.maRating + '</td>' +
                    '<td class="positive">' + ticker.avg5Day.toFixed(2) + '%</td>' +
                    '<td class="positive">' + ticker.last3Min.toFixed(2) + '%</td>';
                
                tbody.appendChild(row);
            }
        }
        
        function selectTicker(symbol) {
            var rows = document.querySelectorAll('#screenerBody tr');
            for (var i = 0; i < rows.length; i++) {
                rows[i].classList.remove('selected');
            }
            
            var selectedRow = document.querySelector('tr[data-symbol="' + symbol + '"]');
            if (selectedRow) {
                selectedRow.classList.add('selected');
            }
            
            selectedTicker = symbol;
            analyzeTicker(symbol);
        }
        
        function showStatus(message, type) {
            var statusEl = document.getElementById('status');
            statusEl.className = 'status ' + type + ' show';
            statusEl.textContent = message;
        }
        
        function generateMockData() {
            var basePrice = 150 + Math.random() * 100;
            var data = [];
            var today = new Date();
            
            for (var i = 15; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                var trend = Math.sin(i / 3) * 3;
                var randomChange = (Math.random() - 0.5) * 4;
                var price = basePrice + trend + randomChange;
                
                data.push({
                    Date: date.toISOString().substring(0, 10),
                    'Adj Close': parseFloat(price.toFixed(2)),
                    Close: parseFloat(price.toFixed(2))
                });
            }
            return data;
        }
        
        function calculateDailyReturns(data) {
            var returns = [];
            for (var i = 1; i < data.length; i++) {
                var currentClose = parseFloat(data[i]['Adj Close']);
                var prevClose = parseFloat(data[i-1]['Adj Close']);
                
                if (prevClose !== 0 && !isNaN(currentClose) && !isNaN(prevClose)) {
                    var returnPct = ((currentClose / prevClose) - 1) * 100;
                    returns.push({
                        date: data[i].Date,
                        close: currentClose,
                        return: returnPct
                    });
                }
            }
            return returns;
        }
        
        async function fetchTickerData(symbol, endDate) {
            var apiKey = 'WWY97VEDHT7BXVWU';
            var url = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=' + symbol + '&apikey=' + apiKey + '&outputsize=full';
            
            try {
                var response = await fetch(url);
                var json = await response.json();
                
                if (json.Note || json.Information || json['Error Message']) {
                    return generateMockData();
                }
                
                var timeSeries = json['Time Series (Daily)'];
                if (!timeSeries) {
                    return generateMockData();
                }
                
                var cutoff = new Date(endDate);
                var data = [];
                
                for (var date in timeSeries) {
                    var values = timeSeries[date];
                    var itemDate = new Date(date);
                    if (itemDate <= cutoff) {
                        data.push({
                            Date: date,
                            'Adj Close': parseFloat(values['5. adjusted close']),
                            Close: parseFloat(values['4. close'])
                        });
                    }
                }
                
                data.sort(function(a, b) {
                    return new Date(a.Date) - new Date(b.Date);
                });
                
                return data.length > 0 ? data : generateMockData();
            } catch (error) {
                return generateMockData();
            }
        }
        
        async function analyzeTicker(symbol) {
            var cutoffDate = document.getElementById('cutoffDate').value;
            
            showStatus('Analyzing ' + symbol + '...', 'loading');
            
            var data = await fetchTickerData(symbol, cutoffDate);
            
            if (!data || data.length === 0) {
                showStatus('Error: Unable to generate data for ' + symbol, 'error');
                return;
            }
            
            var returns = calculateDailyReturns(data);
            
            if (returns.length < 5) {
                showStatus('Error: Not enough trading days available', 'error');
                return;
            }
            
            var last5 = returns.slice(-5);
            var sum = 0;
            for (var i = 0; i < last5.length; i++) {
                sum += last5[i].return;
            }
            var avgReturn = sum / 5;
            
            analysisData = {
                ticker: symbol,
                cutoffDate: cutoffDate,
                avgReturn: avgReturn,
                dailyReturns: last5,
                allReturns: returns
            };
            
            document.getElementById('symbolDisplay').textContent = symbol;
            document.getElementById('dateDisplay').textContent = cutoffDate;
            
            var avgEl = document.getElementById('avgReturn');
            avgEl.textContent = avgReturn.toFixed(2) + '%';
            avgEl.className = 'avg-return-value ' + (avgReturn >= 0 ? 'positive' : 'negative');
            
            var dailyEl = document.getElementById('dailyReturns');
            dailyEl.innerHTML = '';
            
            for (var i = 0; i < last5.length; i++) {
                var day = last5[i];
                var div = document.createElement('div');
                div.className = 'result-item';
                var label = document.createElement('span');
                label.className = 'result-label';
                label.textContent = 'Day ' + (i + 1) + ' (' + day.date + ')';
                var value = document.createElement('span');
                value.className = 'result-value ' + (day.return >= 0 ? 'positive' : 'negative');
                value.textContent = day.return.toFixed(2) + '%';
                div.appendChild(label);
                div.appendChild(value);
                dailyEl.appendChild(div);
            }
            
            var rawDataBody = document.getElementById('rawDataBody');
            rawDataBody.innerHTML = '';
            
            var last10 = returns.slice(-10).reverse();
            for (var i = 0; i < last10.length; i++) {
                var day = last10[i];
                var row = document.createElement('tr');
                var dateCell = document.createElement('td');
                dateCell.textContent = day.date;
                var priceCell = document.createElement('td');
                priceCell.className = 'right';
                priceCell.textContent = '$' + day.close.toFixed(2);
                var returnCell = document.createElement('td');
                returnCell.className = 'right ' + (day.return >= 0 ? 'positive' : 'negative');
                returnCell.textContent = day.return.toFixed(2) + '%';
                row.appendChild(dateCell);
                row.appendChild(priceCell);
                row.appendChild(returnCell);
                rawDataBody.appendChild(row);
            }
            
            document.getElementById('results').classList.add('show');
            showStatus('Analysis complete!', 'success');
        }
        
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!analysisData) return;
            
            var csv = 'Ticker Analysis Report\n\n';
            csv += 'Symbol,' + analysisData.ticker + '\n';
            csv += 'Cutoff Date,' + analysisData.cutoffDate + '\n';
            csv += 'Average 5-Day Return,' + analysisData.avgReturn.toFixed(4) + '%\n\n';
            csv += 'Day,Date,Close Price,Daily Return\n';
            
            for (var i = 0; i < analysisData.dailyReturns.length; i++) {
                var day = analysisData.dailyReturns[i];
                csv += 'Day ' + (i + 1) + ',' + day.date + ',' + day.close.toFixed(2) + ',' + day.return.toFixed(4) + '%\n';
            }
            
            csv += '\n\nAll Daily Returns\n';
            csv += 'Date,Close Price,Daily Return\n';
            for (var i = 0; i < analysisData.allReturns.length; i++) {
                var day = analysisData.allReturns[i];
                csv += day.date + ',' + day.close.toFixed(2) + ',' + day.return.toFixed(4) + '%\n';
            }
            
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Ticker_Analysis_' + analysisData.ticker + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('CSV downloaded!', 'success');
        });
    </script>
</body>
</html>
