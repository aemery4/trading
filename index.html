<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker Screener & Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            background: #f7fafc;
        }
        .file-input-wrapper {
            display: inline-block;
        }
        .file-input-wrapper input[type="file"] {
            display: block;
            margin: 0 auto;
        }
        .btn-file {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: #667eea;
            color: white;
            display: inline-block;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .screener-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .screener-table thead { background: #667eea; color: white; }
        .screener-table th, .screener-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        .screener-table tbody tr:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        .screener-table tbody tr.selected {
            background: #bee3f8;
        }
        .positive { color: #48bb78; font-weight: 600; }
        .negative { color: #f56565; font-weight: 600; }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            display: none;
        }
        .results.show { display: block; }
        .result-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            margin-top: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .result-header:first-child { margin-top: 0; }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-label { font-weight: 600; color: #555; }
        .result-value { font-weight: 600; }
        .avg-return {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        .avg-return-label { font-size: 14px; color: #666; margin-bottom: 5px; }
        .avg-return-value { font-size: 32px; font-weight: 700; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .data-table thead tr { background: #e2e8f0; }
        .data-table th { padding: 10px; text-align: left; border: 1px solid #cbd5e0; font-weight: 600; }
        .data-table td { padding: 8px; border: 1px solid #cbd5e0; }
        .data-table td.right { text-align: right; }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .status.show { display: block; }
        .status.loading { background: #bee3f8; color: #2c5282; }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.error { background: #fed7d7; color: #742a2a; }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #333; }
        .version {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            color: #666;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="version">v46 â€¢ Latest</div>
    <div class="container">
        <h1>ðŸ“Š Ticker Screener & Analysis</h1>
        <p class="subtitle">Upload screener results and analyze qualifying tickers</p>
        
        <div class="upload-section">
            <h3 style="margin-bottom: 15px;">Upload Screener CSV</h3>
            <input type="file" id="csvFile" accept=".csv" class="btn-file">
            <p id="fileName" style="margin-top: 10px; color: #666;"></p>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px;">Market Data API Configuration</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 13px;">API Provider</label>
                <select id="apiProvider" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                    <option value="none">None (assume all available)</option>
                    <option value="polygon">Polygon.io</option>
                    <option value="alpaca">Alpaca Markets</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px;">API Token (Optional)</label>
                <input type="text" id="apiToken" placeholder="Enter your API token" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-family: monospace;">
                <p style="margin-top: 5px; font-size: 11px; color: #666;">
                    <strong>Note:</strong> IEX Cloud shut down in 2024. Use Polygon.io (free tier) or Alpaca Markets (free account) instead.
                </p>
            </div>
        </div>

        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px;">Screening Criteria</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Consecutive Days</label>
                    <input type="number" id="consecutiveDays" value="3" min="1" max="10" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Min Daily Gain (%)</label>
                    <input type="number" id="minDailyGain" value="5" min="0" max="100" step="0.1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Average Days Period</label>
                    <input type="number" id="avgDaysPeriod" value="5" min="1" max="20" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px;">Min Average Gain (%)</label>
                    <input type="number" id="minAvgGain" value="8" min="0" max="100" step="0.1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                </div>
            </div>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                <strong>Example:</strong> With defaults, requires 3 consecutive days each with â‰¥5% gain, and average of last 5 days â‰¥8%
            </p>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn btn-primary" id="processBtn" disabled>Process Screening</button>
            </div>
        </div>

        <div id="screenerSection" style="display: none;">
            <h2 style="margin-bottom: 15px;">Qualifying Tickers</h2>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Screened</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Qualified</div>
                    <div class="stat-value" id="qualifiedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg 5-Day Gain</div>
                    <div class="stat-value" id="avgGain">0%</div>
                </div>
            </div>
            
            <div id="filterSummary" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; line-height: 1.6;"></div>
            
            <div style="overflow-x: auto;">
                <table class="screener-table" id="screenerTable">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Description</th>
                            <th>Tech Rating</th>
                            <th>MA Rating</th>
                            <th>Avg Return</th>
                            <th>Daily Returns</th>
                            <th>API</th>
                        </tr>
                    </thead>
                    <tbody id="screenerBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <label>Cutoff Date for Analysis:</label>
                <input type="date" id="cutoffDate" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; margin: 10px 0;">
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #e0e0e0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filterIEX" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 600;">Only include tickers with API data available</span>
                </label>
                <p style="margin-top: 8px; font-size: 12px; color: #666;">
                    Filters tickers based on market data API availability (Polygon.io or Alpaca). Requires API token above.
                </p>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" id="exportScreenerCSV" disabled>Export Screener CSV</button>
                <button class="btn btn-success" id="exportScreenerBacktest" disabled>Export Backtest Config</button>
                <button class="btn btn-success" id="exportScreenerBot" disabled>Export Bot Config</button>
            </div>
        </div>

        <div id="status" class="status"></div>

        <div class="results" id="results">
            <div class="result-header">Daily Analysis</div>
            <div class="result-item">
                <span class="result-label">Symbol:</span>
                <span class="result-value" id="symbolDisplay"></span>
            </div>
            <div class="result-item">
                <span class="result-label">Cutoff Date:</span>
                <span class="result-value" id="dateDisplay"></span>
            </div>
            
            <div id="validationMessage"></div>
            
            <div class="avg-return">
                <div class="avg-return-label">Average 5-Day Return</div>
                <div class="avg-return-value" id="avgReturn"></div>
            </div>
            <div class="result-header">Last 5 Trading Days</div>
            <div id="dailyReturns"></div>
            <div class="result-header">Raw Data (Last 10 Days)</div>
            <div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Close Price</th>
                            <th>Daily Return</th>
                        </tr>
                    </thead>
                    <tbody id="rawDataBody"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" id="exportBtn">Export CSV</button>
                <button class="btn btn-success" id="exportBacktestBtn">Export Backtest Config</button>
                <button class="btn btn-success" id="exportBotBtn">Export Bot Config</button>
            </div>
        </div>
    </div>

    <script>
        var screenerData = [];
        var qualifiedTickers = [];
        var analysisData = null;
        var selectedTicker = null;
        
        document.getElementById('cutoffDate').valueAsDate = new Date();
        
        document.getElementById('csvFile').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = 'Loading: ' + file.name;
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsed:', results.data.length, 'rows');
                    screenerData = results.data;
                    document.getElementById('fileName').textContent = 'Loaded: ' + file.name + ' (' + results.data.length + ' rows)';
                    document.getElementById('processBtn').disabled = false;
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        });
        
        document.getElementById('processBtn').addEventListener('click', function() {
            if (screenerData.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }
            processScreenerData();
        });
        
        async function processScreenerData() {
            console.log('Processing screener data...');
            console.log('Sample row:', screenerData[0]);
            console.log('Column names:', Object.keys(screenerData[0]));
            
            qualifiedTickers = [];
            
            var stats = {
                total: screenerData.length,
                hasRatings: 0,
                strongBuyBoth: 0,
                checking: 0,
                meetsLast3: 0,
                meetsAvg5: 0,
                qualified: 0
            };
            
            var cutoffDate = document.getElementById('cutoffDate').value;
            
            // First pass - filter by ratings
            var strongBuyCandidates = [];
            
            for (var i = 0; i < screenerData.length; i++) {
                var row = screenerData[i];
                
                var techRating = row['Technical Rating 1 day'] || row['TechnicalRating 1 day'] || row['Technical Rating'];
                var maRating = row['Moving Averages Rating 1 day'] || row['MovingAveragesRating 1 day'] || row['Moving Averages Rating'];
                
                if (!techRating || !maRating) continue;
                stats.hasRatings++;
                
                var techLC = techRating.toLowerCase().replace(/\s+/g, '');
                var maLC = maRating.toLowerCase().replace(/\s+/g, '');
                
                var isStrongBuy = (techLC === 'strongbuy') && (maLC === 'strongbuy');
                
                if (isStrongBuy) {
                    stats.strongBuyBoth++;
                    strongBuyCandidates.push(row);
                }
            }
            
            console.log('Found', strongBuyCandidates.length, 'Strong Buy candidates');
            showStatus('Found ' + strongBuyCandidates.length + ' Strong Buy candidates. Validating in parallel...', 'loading');
            
            // Process in batches of 10 at a time for speed
            var batchSize = 10;
            var totalToCheck = Math.min(strongBuyCandidates.length, 100); // Limit to first 100 to keep it fast
            
            if (strongBuyCandidates.length > 100) {
                console.log('Limiting to first 100 candidates for performance');
            }
            
            for (var batchStart = 0; batchStart < totalToCheck; batchStart += batchSize) {
                var batchEnd = Math.min(batchStart + batchSize, totalToCheck);
                var batch = strongBuyCandidates.slice(batchStart, batchEnd);
                
                showStatus('Validating batch ' + Math.floor(batchStart / batchSize + 1) + ' (' + batchStart + '-' + batchEnd + ' of ' + totalToCheck + ')...', 'loading');
                
                var promises = batch.map(function(row) {
                    return validateTicker(row, cutoffDate, stats);
                });
                
                var results = await Promise.all(promises);
                
                for (var i = 0; i < results.length; i++) {
                    if (results[i]) {
                        qualifiedTickers.push(results[i]);
                        stats.qualified++;
                        displayQualifiedTickers(stats);
                    }
                }
            }
            
            console.log('=== SCREENING STATISTICS ===');
            console.log('Total records:', stats.total);
            console.log('Have both ratings:', stats.hasRatings);
            console.log('Strong Buy (both):', stats.strongBuyBoth);
            console.log('Checked daily data:', stats.checking);
            console.log('Meet last 3 days >= 5%:', stats.meetsLast3);
            console.log('Meet avg 5-day >= 8%:', stats.meetsAvg5);
            console.log('QUALIFIED:', stats.qualified);
            
            displayQualifiedTickers(stats);
            showStatus('Screening complete! Found ' + stats.qualified + ' qualified tickers.', 'success');
        }
        
        async function validateTicker(row, cutoffDate, stats) {
            var symbol = row['Symbol'];
            if (!symbol) return null;
            
            stats.checking++;
            
            // Get configured parameters
            var consecutiveDays = parseInt(document.getElementById('consecutiveDays').value) || 3;
            var minDailyGain = parseFloat(document.getElementById('minDailyGain').value) || 5;
            var avgDaysPeriod = parseInt(document.getElementById('avgDaysPeriod').value) || 5;
            var minAvgGain = parseFloat(document.getElementById('minAvgGain').value) || 8;
            
            try {
                var data = await fetchTickerData(symbol, cutoffDate);
                
                if (!data || data.length === 0) return null;
                
                var returns = calculateDailyReturns(data);
                
                if (returns.length < Math.max(consecutiveDays, avgDaysPeriod)) return null;
                
                // Check consecutive days criterion
                var lastNDays = returns.slice(-consecutiveDays);
                var allDaysAboveMin = true;
                for (var i = 0; i < lastNDays.length; i++) {
                    if (lastNDays[i].return < minDailyGain) {
                        allDaysAboveMin = false;
                        break;
                    }
                }
                
                if (!allDaysAboveMin) return null;
                stats.meetsLast3++;
                
                // Check average criterion
                var lastAvgDays = returns.slice(-avgDaysPeriod);
                var sum = 0;
                for (var j = 0; j < lastAvgDays.length; j++) {
                    sum += lastAvgDays[j].return;
                }
                var avgReturn = sum / avgDaysPeriod;
                
                if (avgReturn < minAvgGain) return null;
                stats.meetsAvg5++;
                
                // Check IEX availability
                var hasIEX = await checkIEXAvailability(symbol);
                
                // Collect the consecutive days data
                var consecutiveDaysData = [];
                for (var i = 0; i < lastNDays.length; i++) {
                    consecutiveDaysData.push(lastNDays[i].return);
                }
                
                return {
                    symbol: symbol,
                    description: row['Description'],
                    techRating: row['Technical Rating 1 day'] || row['TechnicalRating 1 day'],
                    maRating: row['Moving Averages Rating 1 day'] || row['MovingAveragesRating 1 day'],
                    avg5Day: avgReturn,
                    consecutiveDays: consecutiveDaysData,
                    hasIEX: hasIEX
                };
                
            } catch (error) {
                console.log('Error checking', symbol, ':', error);
                return null;
            }
        }
        
        async function checkIEXAvailability(symbol) {
            var apiProvider = document.getElementById('apiProvider').value;
            var apiToken = document.getElementById('apiToken').value.trim();
            
            // If no provider or token, assume all tickers are available
            if (apiProvider === 'none' || !apiToken) {
                console.log(symbol, '- No API configured, assuming available');
                return true;
            }
            
            try {
                var url;
                
                if (apiProvider === 'polygon') {
                    // Polygon.io API - check if ticker exists
                    url = 'https://api.polygon.io/v3/reference/tickers/' + symbol + '?apiKey=' + apiToken;
                } else if (apiProvider === 'alpaca') {
                    // Alpaca Markets API - check if asset exists
                    url = 'https://paper-api.alpaca.markets/v2/assets/' + symbol;
                }
                
                console.log('Checking', apiProvider, 'for:', symbol);
                
                var headers = {};
                if (apiProvider === 'alpaca') {
                    headers['APCA-API-KEY-ID'] = apiToken;
                    headers['APCA-API-SECRET-KEY'] = apiToken; // User needs to provide both in token field
                }
                
                var response = await fetch(url, { headers: headers });
                
                if (response.ok) {
                    console.log(symbol, '- Available on', apiProvider);
                    return true;
                } else if (response.status === 404) {
                    console.log(symbol, '- NOT available on', apiProvider);
                    return false;
                } else if (response.status === 401 || response.status === 403) {
                    console.log(symbol, '- API authentication failed');
                    return true; // Assume available to continue
                } else {
                    console.log(symbol, '- Check failed (status:', response.status + ')');
                    return false;
                }
            } catch (error) {
                console.log(symbol, '- API check error:', error.message);
                return true; // On error, assume available
            }
        }
        
        function displayQualifiedTickers(stats) {
            document.getElementById('screenerSection').style.display = 'block';
            
            document.getElementById('totalCount').textContent = stats ? stats.total : screenerData.length;
            document.getElementById('qualifiedCount').textContent = qualifiedTickers.length;
            
            var filterSummary = document.getElementById('filterSummary');
            if (stats) {
                filterSummary.innerHTML = '<strong>Filtering Breakdown:</strong><br>' +
                    'Total screened: ' + stats.total + '<br>' +
                    'Have ratings: ' + stats.hasRatings + '<br>' +
                    'Strong Buy (both): ' + stats.strongBuyBoth + '<br>' +
                    'Validated with daily data: ' + stats.checking + '<br>' +
                    'Last 3 days each â‰¥ 5%: ' + stats.meetsLast3 + '<br>' +
                    'Avg 5-day â‰¥ 8%: ' + stats.meetsAvg5 + '<br>' +
                    '<strong>Final Qualified: ' + stats.qualified + '</strong>';
            }
            
            if (qualifiedTickers.length > 0) {
                var totalGain = 0;
                for (var i = 0; i < qualifiedTickers.length; i++) {
                    totalGain += qualifiedTickers[i].avg5Day;
                }
                var avgGain = totalGain / qualifiedTickers.length;
                document.getElementById('avgGain').textContent = avgGain.toFixed(2) + '%';
            }
            
            var tbody = document.getElementById('screenerBody');
            tbody.innerHTML = '';
            
            var filterIEX = document.getElementById('filterIEX').checked;
            var displayTickers = filterIEX ? qualifiedTickers.filter(function(t) { return t.hasIEX; }) : qualifiedTickers;
            
            for (var i = 0; i < displayTickers.length; i++) {
                var ticker = displayTickers[i];
                var row = document.createElement('tr');
                row.setAttribute('data-symbol', ticker.symbol);
                row.onclick = function() {
                    var symbol = this.getAttribute('data-symbol');
                    selectTicker(symbol);
                };
                
                var dailyReturnsStr = '';
                for (var j = 0; j < ticker.consecutiveDays.length; j++) {
                    dailyReturnsStr += ticker.consecutiveDays[j].toFixed(2) + '%';
                    if (j < ticker.consecutiveDays.length - 1) dailyReturnsStr += ', ';
                }
                
                var iexBadge = ticker.hasIEX ? '<span style="color: #48bb78;">âœ“</span>' : '<span style="color: #f56565;">âœ—</span>';
                
                row.innerHTML = '<td><strong>' + ticker.symbol + '</strong></td>' +
                    '<td>' + (ticker.description || '') + '</td>' +
                    '<td>' + ticker.techRating + '</td>' +
                    '<td>' + ticker.maRating + '</td>' +
                    '<td class="positive">' + ticker.avg5Day.toFixed(2) + '%</td>' +
                    '<td class="positive">' + dailyReturnsStr + '</td>' +
                    '<td style="text-align: center;">' + iexBadge + '</td>';
                
                tbody.appendChild(row);
            }
            
            showStatus('Screening complete! Found ' + qualifiedTickers.length + ' qualified tickers.', 'success');
            
            document.getElementById('exportScreenerCSV').disabled = false;
            document.getElementById('exportScreenerBacktest').disabled = false;
            document.getElementById('exportScreenerBot').disabled = false;
        }
        
        function selectTicker(symbol) {
            var rows = document.querySelectorAll('#screenerBody tr');
            for (var i = 0; i < rows.length; i++) {
                rows[i].classList.remove('selected');
            }
            
            var selectedRow = document.querySelector('tr[data-symbol="' + symbol + '"]');
            if (selectedRow) {
                selectedRow.classList.add('selected');
            }
            
            selectedTicker = symbol;
            analyzeTicker(symbol);
        }
        
        function showStatus(message, type) {
            var statusEl = document.getElementById('status');
            statusEl.className = 'status ' + type + ' show';
            statusEl.textContent = message;
        }
        
        function generateMockData() {
            var basePrice = 150 + Math.random() * 100;
            var data = [];
            var today = new Date();
            
            for (var i = 15; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                var trend = Math.sin(i / 3) * 3;
                var randomChange = (Math.random() - 0.5) * 4;
                var price = basePrice + trend + randomChange;
                
                data.push({
                    Date: date.toISOString().substring(0, 10),
                    'Adj Close': parseFloat(price.toFixed(2)),
                    Close: parseFloat(price.toFixed(2))
                });
            }
            return data;
        }
        
        function calculateDailyReturns(data) {
            var returns = [];
            for (var i = 1; i < data.length; i++) {
                var currentClose = parseFloat(data[i]['Adj Close']);
                var prevClose = parseFloat(data[i-1]['Adj Close']);
                
                if (prevClose !== 0 && !isNaN(currentClose) && !isNaN(prevClose)) {
                    var returnPct = ((currentClose / prevClose) - 1) * 100;
                    returns.push({
                        date: data[i].Date,
                        close: currentClose,
                        return: returnPct
                    });
                }
            }
            return returns;
        }
        
        async function fetchTickerData(symbol, endDate) {
            var apiKey = 'WWY97VEDHT7BXVWU';
            var url = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=' + symbol + '&apikey=' + apiKey + '&outputsize=full';
            
            try {
                var response = await fetch(url);
                var json = await response.json();
                
                if (json.Note || json.Information || json['Error Message']) {
                    return generateMockData();
                }
                
                var timeSeries = json['Time Series (Daily)'];
                if (!timeSeries) {
                    return generateMockData();
                }
                
                var cutoff = new Date(endDate);
                var data = [];
                
                for (var date in timeSeries) {
                    var values = timeSeries[date];
                    var itemDate = new Date(date);
                    if (itemDate <= cutoff) {
                        data.push({
                            Date: date,
                            'Adj Close': parseFloat(values['5. adjusted close']),
                            Close: parseFloat(values['4. close'])
                        });
                    }
                }
                
                data.sort(function(a, b) {
                    return new Date(a.Date) - new Date(b.Date);
                });
                
                return data.length > 0 ? data : generateMockData();
            } catch (error) {
                return generateMockData();
            }
        }
        
        async function analyzeTicker(symbol) {
            var cutoffDate = document.getElementById('cutoffDate').value;
            
            showStatus('Analyzing ' + symbol + '...', 'loading');
            
            var data = await fetchTickerData(symbol, cutoffDate);
            
            if (!data || data.length === 0) {
                showStatus('Error: Unable to generate data for ' + symbol, 'error');
                return;
            }
            
            var returns = calculateDailyReturns(data);
            
            if (returns.length < 5) {
                showStatus('Error: Not enough trading days available', 'error');
                return;
            }
            
            var last5 = returns.slice(-5);
            var last3 = returns.slice(-3);
            
            var sum = 0;
            for (var i = 0; i < last5.length; i++) {
                sum += last5[i].return;
            }
            var avgReturn = sum / 5;
            
            var last3Min = Math.min(last3[0].return, last3[1].return, last3[2].return);
            var allLast3Above5 = last3[0].return >= 5 && last3[1].return >= 5 && last3[2].return >= 5;
            
            analysisData = {
                ticker: symbol,
                cutoffDate: cutoffDate,
                avgReturn: avgReturn,
                last3Min: last3Min,
                allLast3Above5: allLast3Above5,
                dailyReturns: last5,
                allReturns: returns
            };
            
            document.getElementById('symbolDisplay').textContent = symbol;
            document.getElementById('dateDisplay').textContent = cutoffDate;
            
            var avgEl = document.getElementById('avgReturn');
            avgEl.textContent = avgReturn.toFixed(2) + '%';
            avgEl.className = 'avg-return-value ' + (avgReturn >= 0 ? 'positive' : 'negative');
            
            // Add validation message for last 3 days
            var validationMsg = '';
            if (!allLast3Above5) {
                validationMsg = '<div style="background: #fed7d7; color: #742a2a; padding: 10px; border-radius: 5px; margin: 10px 0;"><strong>âš  Warning:</strong> Not all of the last 3 days reached 5% individually (min: ' + last3Min.toFixed(2) + '%)</div>';
            } else {
                validationMsg = '<div style="background: #c6f6d5; color: #22543d; padding: 10px; border-radius: 5px; margin: 10px 0;"><strong>âœ“ Validated:</strong> All last 3 days met the 5% threshold</div>';
            }
            
            document.getElementById('validationMessage').innerHTML = validationMsg;
            
            var dailyEl = document.getElementById('dailyReturns');
            dailyEl.innerHTML = '';
            
            for (var i = 0; i < last5.length; i++) {
                var day = last5[i];
                var div = document.createElement('div');
                div.className = 'result-item';
                var label = document.createElement('span');
                label.className = 'result-label';
                label.textContent = 'Day ' + (i + 1) + ' (' + day.date + ')';
                var value = document.createElement('span');
                value.className = 'result-value ' + (day.return >= 0 ? 'positive' : 'negative');
                value.textContent = day.return.toFixed(2) + '%';
                div.appendChild(label);
                div.appendChild(value);
                dailyEl.appendChild(div);
            }
            
            var rawDataBody = document.getElementById('rawDataBody');
            rawDataBody.innerHTML = '';
            
            var last10 = returns.slice(-10).reverse();
            for (var i = 0; i < last10.length; i++) {
                var day = last10[i];
                var row = document.createElement('tr');
                var dateCell = document.createElement('td');
                dateCell.textContent = day.date;
                var priceCell = document.createElement('td');
                priceCell.className = 'right';
                priceCell.textContent = '$' + day.close.toFixed(2);
                var returnCell = document.createElement('td');
                returnCell.className = 'right ' + (day.return >= 0 ? 'positive' : 'negative');
                returnCell.textContent = day.return.toFixed(2) + '%';
                row.appendChild(dateCell);
                row.appendChild(priceCell);
                row.appendChild(returnCell);
                rawDataBody.appendChild(row);
            }
            
            document.getElementById('results').classList.add('show');
            showStatus('Analysis complete!', 'success');
        }
        
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!analysisData) return;
            
            var csv = 'Ticker Analysis Report\n\n';
            csv += 'Symbol,' + analysisData.ticker + '\n';
            csv += 'Cutoff Date,' + analysisData.cutoffDate + '\n';
            csv += 'Average 5-Day Return,' + analysisData.avgReturn.toFixed(4) + '%\n\n';
            csv += 'Day,Date,Close Price,Daily Return\n';
            
            for (var i = 0; i < analysisData.dailyReturns.length; i++) {
                var day = analysisData.dailyReturns[i];
                csv += 'Day ' + (i + 1) + ',' + day.date + ',' + day.close.toFixed(2) + ',' + day.return.toFixed(4) + '%\n';
            }
            
            csv += '\n\nAll Daily Returns\n';
            csv += 'Date,Close Price,Daily Return\n';
            for (var i = 0; i < analysisData.allReturns.length; i++) {
                var day = analysisData.allReturns[i];
                csv += day.date + ',' + day.close.toFixed(2) + ',' + day.return.toFixed(4) + '%\n';
            }
            
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Ticker_Analysis_' + analysisData.ticker + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('CSV downloaded!', 'success');
        });
        
        document.getElementById('exportBacktestBtn').addEventListener('click', function() {
            if (qualifiedTickers.length === 0) {
                alert('No qualified tickers to export');
                return;
            }
            
            var cutoffDate = document.getElementById('cutoffDate').value;
            
            var tickersObj = {};
            for (var i = 0; i < qualifiedTickers.length; i++) {
                var ticker = qualifiedTickers[i];
                var avgReturn = ticker.avg5Day / 100;
                tickersObj[ticker.symbol] = parseFloat(avgReturn.toFixed(4));
            }
            
            var backtestConfig = {
                backtest: {
                    date: cutoffDate,
                    tickers: tickersObj
                }
            };
            
            var jsonStr = JSON.stringify(backtestConfig, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'backtest_settings.json';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Backtest config downloaded!', 'success');
        });
        
        document.getElementById('exportBotBtn').addEventListener('click', function() {
            if (qualifiedTickers.length === 0) {
                alert('No qualified tickers to export');
                return;
            }
            
            var tickersObj = {};
            for (var i = 0; i < qualifiedTickers.length; i++) {
                var ticker = qualifiedTickers[i];
                var avgReturn = ticker.avg5Day / 100;
                tickersObj[ticker.symbol] = parseFloat(avgReturn.toFixed(4));
            }
            
            var botConfig = {
                trading_parameters: {
                    position_size: 1000,
                    buffer_percent: 0.03,
                    initial_stop_percent: 0.03,
                    tight_stop_percent: 0.005,
                    profit_threshold: 0.055,
                    stabilization_minutes: 5,
                    rise_rate_threshold: 0.005,
                    poll_interval: 30
                },
                live_trading: {
                    tickers: tickersObj
                }
            };
            
            var jsonStr = JSON.stringify(botConfig, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'bot_settings.json';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Bot config downloaded!', 'success');
        });
        
        document.getElementById('filterIEX').addEventListener('change', function() {
            displayQualifiedTickers();
        });
        
        document.getElementById('exportScreenerCSV').addEventListener('click', function() {
            if (qualifiedTickers.length === 0) {
                alert('No qualified tickers to export');
                return;
            }
            
            var filterIEX = document.getElementById('filterIEX').checked;
            var exportTickers = filterIEX ? qualifiedTickers.filter(function(t) { return t.hasIEX; }) : qualifiedTickers;
            
            var csv = 'Symbol,Description,Tech Rating,MA Rating,Avg Return %,Daily Returns,API Available\n';
            
            for (var i = 0; i < exportTickers.length; i++) {
                var ticker = exportTickers[i];
                var dailyReturnsStr = ticker.consecutiveDays.map(function(r) { return r.toFixed(2) + '%'; }).join('; ');
                csv += ticker.symbol + ',"' + (ticker.description || '') + '",' + ticker.techRating + ',' + ticker.maRating + ',' + ticker.avg5Day.toFixed(2) + '%,"' + dailyReturnsStr + '",' + (ticker.hasIEX ? 'Yes' : 'No') + '\n';
            }
            
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Qualified_Tickers_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Screener CSV downloaded!', 'success');
        });
        
        document.getElementById('exportScreenerBacktest').addEventListener('click', function() {
            if (qualifiedTickers.length === 0) {
                alert('No qualified tickers to export');
                return;
            }
            
            var filterIEX = document.getElementById('filterIEX').checked;
            var exportTickers = filterIEX ? qualifiedTickers.filter(function(t) { return t.hasIEX; }) : qualifiedTickers;
            
            var cutoffDate = document.getElementById('cutoffDate').value;
            
            var tickersObj = {};
            for (var i = 0; i < exportTickers.length; i++) {
                var ticker = exportTickers[i];
                var avgReturn = ticker.avg5Day / 100;
                tickersObj[ticker.symbol] = parseFloat(avgReturn.toFixed(4));
            }
            
            var backtestConfig = {
                backtest: {
                    date: cutoffDate,
                    tickers: tickersObj
                }
            };
            
            var jsonStr = JSON.stringify(backtestConfig, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'backtest_settings.json';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Backtest config downloaded!', 'success');
        });
        
        document.getElementById('exportScreenerBot').addEventListener('click', function() {
            if (qualifiedTickers.length === 0) {
                alert('No qualified tickers to export');
                return;
            }
            
            var filterIEX = document.getElementById('filterIEX').checked;
            var exportTickers = filterIEX ? qualifiedTickers.filter(function(t) { return t.hasIEX; }) : qualifiedTickers;
            
            var tickersObj = {};
            for (var i = 0; i < exportTickers.length; i++) {
                var ticker = exportTickers[i];
                var avgReturn = ticker.avg5Day / 100;
                tickersObj[ticker.symbol] = parseFloat(avgReturn.toFixed(4));
            }
            
            var botConfig = {
                trading_parameters: {
                    position_size: 1000,
                    buffer_percent: 0.03,
                    initial_stop_percent: 0.03,
                    tight_stop_percent: 0.005,
                    profit_threshold: 0.055,
                    stabilization_minutes: 5,
                    rise_rate_threshold: 0.005,
                    poll_interval: 30
                },
                live_trading: {
                    tickers: tickersObj
                }
            };
            
            var jsonStr = JSON.stringify(botConfig, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'bot_settings.json';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('Bot config downloaded!', 'success');
        });
    </script>
</body>
</html>
